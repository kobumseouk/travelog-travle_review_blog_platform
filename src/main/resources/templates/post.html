<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" >
<head th:replace="~{fragments/header :: header}">
    <meta charset="UTF-8">
</head>
<body class="h-full flex flex-col">
<div th:replace="~{fragments/bodyHeader :: bodyHeader}"></div>
<link rel="stylesheet" href="/css/comment_photos.css">
<link rel="stylesheet" href="/css/comment_paging.css">
<link rel="stylesheet" href="/css/reply.css">
<header>
    <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900" th:text="${post.title}">게시글 제목</h1>
    </div>
</header>
<div class="h-full">
    <main class="flex flex-col md:flex-row md:w-[90%]"> <!-- 모바일에서는 flex-col, 데스크탑에서는 flex-row -->
        <!-- 게시글 inner part -->
        <div class="md:w-3/5 w-[90%] m-10 bg-gray-50 p-6 shadow-xl rounded-lg flex-shrink-0" style="align-self: flex-start;">
            <div class="flex items-center justify-between">
                <div class="inline-flex items-center">
                    <img src="data:image/jpeg;base64,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" alt="프로필 사진" class="w-12 h-12 rounded-full border-2 border-gray-500">
                    <div class="ml-4">
                        <h2 class="text-xl font-bold text-gray-900" th:text="${post.memberName}">작성자</h2>
                        <p class="text-gray-600" > <strong>여행 일정</strong> <span th:text="${post.periodStart} + ' ~ ' + ${post.periodEnd}"></span> </p>
                        <p class="text-gray-600" > <strong>작성 일자</strong> <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span> </p>
                    </div>
                </div>
                <div class="flex items-center">
                    <p class="text-gray-600 mr-4"> <strong>조회수:</strong> <span th:text="${post.views}"></span> </p>
                    <p class="text-gray-600"> <strong>추천수:</strong> <span th:text="${post.recommends}"></span> </p>
                </div>
            </div>
            <div class="bg-gray-200 mt-4 mb-4 p-6 rounded-lg">
                <div th:if="${post.photos != null and not #lists.isEmpty(post.photos)}">
                    <p class="text-sm mt-6">첨부한 이미지</p>
                    <div class="img-container grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="mt-1" th:each="photo : ${post.photos}">
                            <a href="#" class="image-link" th:data-base64="${photo}" onclick="openImage(this.dataset.base64)">
                                <img th:src="'data:image/jpeg;base64,' + ${photo}"/>
                            </a>
                        </div>
                    </div>
                </div>
                <p class="text-gray-700" style="white-space: pre-line; word-break: break-all" th:text="${post.content}">게시글 내용</p>
            </div>
            <div class="flex justify-between mt-4">
                <!--목록 버튼-->
                <a th:href="@{/board/{regionMajor}/{boardId}/posts(regionMajor=${regionMajor},boardId=${boardId})}"
                    class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition duration-200">목록</a>
                <!--추천 버튼-->
                <button th:if="${loginMember != null}"
                        th:onclick="|location.href='@{/board/{regionMajor}/{boardId}/posts/{postId}/like(regionMajor=${regionMajor},boardId=${boardId},postId=${post.id})}'|"
                        class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-700 transition duration-200">
                    <span class="material-symbols-outlined" style="font-size: 20px; vertical-align: middle;">thumb_up</span>
                    추천
                </button>

                <div th:if="${loginMember != null and loginMember == post.memberId}">
                    <!--수정 버튼-->
                    <button th:onclick="|location.href='@{/board/{regionMajor}/{boardId}/posts/post-new(regionMajor=${regionMajor},boardId=${boardId},postId=${post.id})}'|"
                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition duration-200 mr-2">수정</button>
                    <!--삭제 버튼-->
                    <button type="button" onclick="deletePost(this)" th:data-postId="${post.id}" th:data-region="${regionMajor}" th:data-board="${boardId}" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition duration-200">삭제</button>
                </div>
            </div>
        </div>
        <div class="w-full md:w-[37%] w-90% mb-10 md:m-10 bg-gray-50 p-6 shadow-xl rounded-lg flex-shrink-0" style="align-self: flex-start;">

            <!--            여행 후기 게시판에만 평균 평점 출력-->
            <div class="flex flex-row justify-start" th:if="${post.boardCategory == '여행후기'}">
                <p class="font-bold text-gray-500 mr-2" th:text="${averageRating == 0.0} ? '등록된 평점이 없습니다!' : '평균 평점 : ' + ${averageRating}"></p>
                <div th:if="${averageRating != 0.0}" class="flex flex-row justify-start align-center">
                    <img th:each="i : ${#numbers.sequence(1, averageRating)}" src="/images/full_star.png" style="width: 20px; height: 20px" class="flex flex-inline"/>
                    <span th:if="${averageRating%1.0 != 0}" class="flex flex-inline">
                    <!-- 반 별 출력-->
                    <img src="/images/half_star.png" style="width: 20px; height: 20px"/>
                    <span th:if="${averageRating < 4}" class="flex flex-inline">
                        <img th:each="i : ${#numbers.sequence(averageRating + 2, 5)}" src="/images/empty_star.png" style="width: 20px; height: 20px"
                             th:if="${averageRating < 5}"/>
                    </span>
                </span>
                    <span th:if="${averageRating%1.0 == 0}" class="flex flex-inline">
                    <img th:each="i : ${#numbers.sequence(averageRating + 1, 5)}"
                         th:if="${averageRating < 5}" src="/images/empty_star.png" style="width: 20px; height: 20px"/>
                </span>
                </div>
            </div>

            <form class="mt-5 mb-5" th:action="@{/api/comment/{postId}(postId=${postId})}" th:object="${commentRequestDto}" method="post" enctype="multipart/form-data" onsubmit="return validateForm()"
                  th:data-post-id="${postId}" th:data-board-id="${boardId}" th:data-region-major="${regionMajor}">
                <label th:for="content" class="block text-lg font-semibold mb-2"><strong>댓글 작성</strong></label>

                <div class="flex flex-col">
                    <!--                    여행후기 게시판에만 평점 등록-->
                    <div th:if="${post.boardCategory == '여행후기'}">
                        <label for="rating" class="block text-sm text-gray-700 mb-1">평점</label>
                        <select th:field="*{rating}" id="rating" class="border border-gray-300 rounded-lg p-2 mb-2" style="max-width: 120px;">
                            <option value="5">★★★★★</option>
                            <option value="4">★★★★☆</option>
                            <option value="3">★★★☆☆</option>
                            <option value="2">★★☆☆☆</option>
                            <option value="1">★☆☆☆☆</option>
                        </select>
                    </div>

                    <textarea th:field="*{content}" class="flex-1 border border-gray-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 mb-2" placeholder="작성 내용을 입력하세요" rows="5" required></textarea>

                    <div class="mb-2">
                        <input type="file" th:field="*{photos}" multiple id="file-input" class="hidden" />
                        <span class="text-sm text-gray-500 mt-2 block">최대 5개 사진 업로드 가능, 각 사진은 16MB 이하만 가능</span>

                        <!-- 업로드 된 사진 이름 -->
                        <div id="file-info" class="mt-2 text-gray-500"></div>
                        <!-- 업로드 된 사진 미리보기 -->
                        <div id="image-preview" class="mt-2 mb-6 image-preview-container"></div>

                        <div class="flex flex-row justify-between">
                            <label for="file-input" class="flex items-center justify-center px-4 py-2 bg-blue-500 text-white rounded-lg cursor-pointer hover:bg-blue-600 transition duration-300">
                                파일 선택하기
                            </label>
                            <button type="submit" class="bg-blue-500 text-white rounded-lg px-2 py-2 hover:bg-blue-600 transition duration-300">댓글 작성</button>
                        </div>

                    </div>
                </div>

            </form>

            <!-- 정렬 조건 입력 -->
            <form id="sortForm" th:action="@{/board/{regionMajor}/{boardId}/posts/{postId}(regionMajor=${regionMajor}, boardId=${boardId}, postId=${postId})}" method="get" th:object="${commentPagingInfo}"
                  class="flex flex-col space-y-4 p-4 mb-4">
                <label class="font-semibold text-lg">댓글 정렬 기준 선택</label>
                <div class="flex justify-start">
                    <select id="commentPagingSize" name="commentPagingSize" th:field="*{commentPagingSize}"
                            class="border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 mr-2">
                        <option value="1" th:selected="${commentPagingInfo.commentPagingSize == 1}">1개씩 보기</option>
                        <option value="5" th:selected="${commentPagingInfo.commentPagingSize == 5}">5개씩 보기</option>
                        <option value="10" th:selected="${commentPagingInfo.commentPagingSize == 10}">10개씩 보기</option>

                    </select>
                    <select id="commentSort" name="commentSort" th:field="*{commentSort}"
                            class="border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="createdAt" th:selected="${commentPagingInfo.commentSort == 'createdAt'}">최신순</option>
                        <option value="commentLikes" th:selected="${commentPagingInfo.commentSort == 'commentLikes'}">추천순</option>
                    </select>

                    <button type="button" onclick="submitForm()" class="ml-2 bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition duration-200">
                        정렬
                    </button>
                </div>

            </form>

            <div th:each="comment : ${comments}" class="flex items-start mb-4">
                <div class="flex w-2 h-2 bg-gray-400 rounded-full mr-4 mt-3"></div>
                <div class="flex-1">
                    <div class="flex flex-row justify-between items-center">


                        <div class="flex flex-row items-center">
                            <p class="font-bold mt-1 mb-2" th:text="${comment.getMember().name}"></p>
                            <!--                            여행후기 게시판에만 평점 출력-->
                            <div class="ml-2 flex flex-row items-center" th:if="${post.boardCategory == '여행후기'}">
                                <img th:each="i : ${#numbers.sequence(1, comment.getRating())}" src="/images/full_star.png" class="w-5 h-5 -translate-y-1"/>
                                <img th:each="i : ${#numbers.sequence(comment.getRating() + 1, 5)}" src="/images/empty_star.png" class="w-5 h-5 -translate-y-1" th:if="${comment.getRating() < 5}"/>
                            </div>
                        </div>

                        <!-- 로그인 한 회원만 좋아요 가능! -->
                        <button th:if="${loginMember != null}" id="like-btn"
                                th:data-comment-id="${comment.id}" th:data-region-major="${regionMajor}" th:data-post-id="${post.id}" th:data-board-id="${boardId}"
                                class="bg-purple-500 text-white font-semibold py-1 px-2 rounded hover:bg-purple-700 items-center rounded-lg mb-2"
                                onclick="likeComment(this)">
                            <span class="material-symbols-outlined" style="font-size: 16px">thumb_up</span>
                            <span th:text="${comment.getCommentLikes().size()}" style="font-size: 12px"></span>
                        </button>
                    </div>

                    <div class="relative mb-1">
                        <div class="bg-gray-200 p-4 rounded-lg">
                            <span th:text="${comment.content}"></span>
                            <div th:if="${comment.getCommentPhotos().size() > 0}">
                                <p class="text-sm mt-6">첨부한 이미지</p>
                                <div class="img-container">
                                    <div class="mt-1" th:each="photo : ${comment.getCommentPhotos()}">
                                        <a href="#" class="image-link" th:data-base64="${photo.base64Image}" onclick="openImage(this.dataset.base64)">
                                            <img th:src="'data:image/jpeg;base64,' + ${photo.base64Image}"/>
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- 로그인 정보 일치하는 회원만 수정, 삭제 가능함--> <!--조회수 감소 기능-->
                            <div class="flex justify-end mt-2 mb-1">
                                <p th:if="${loginMember != null and loginMember == comment.member.id}">
                                    <a th:href="@{/board/{regionMajor}/{boardId}/posts/{postId}/comments/{commentId}(regionMajor=${regionMajor}, boardId=${boardId}, postId=${postId}, commentId=${comment.id})}">
                                        <span class="material-symbols-outlined" style="color: blue">edit_note</span>
                                    </a>
                                    <button type="button" onclick="deleteComment(this)" th:data-id="${comment.id}">
                                        <span class="material-symbols-outlined" style="color: red">delete</span>
                                    </button>
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between mb-2">

                        <button class="text-gray-500" id="showRepliesButton" onclick="toggleReplies(this)" th:data-comment-id="${comment.id}" >대댓글 보기</button>

                        <span class="text-gray-500 text-sm ml-1"
                              th:text="${comment.editedAt==null} ?
                                    ${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')} : ${'(수정) ' + #temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>

                    <div th:id="'replyContainer-' + ${comment.id}" th:data-login-member-id="${loginMember != null ? loginMember : 'null'}"
                         th:data-region-major="${regionMajor}" th:data-board-id="${boardId}" th:data-post-id="${post.id}"
                         class="mt-10 border border-gray-300 rounded-lg p-4" style="display: none;"></div> <!-- 기본적으로 숨김 -->

                </div>
            </div>

            <div class="pagination">
                <button class="pagination-button" th:disabled="${comments.getNumber()}==0"
                        th:onclick="|location.href='@{/board/{regionMajor}/{boardId}/posts/{postId}(regionMajor=${regionMajor}, boardId=${boardId}, postId=${postId}, commentPage=${1}, commentPagingSize=${commentPagingInfo.commentPagingSize}, commentSort=${commentPagingInfo.commentSort} ) }'|">
                    <<</button>
                <button class="pagination-button" th:disabled="${!comments.hasPrevious()}"
                        th:onclick="|location.href='@{/board/{regionMajor}/{boardId}/posts/{postId}(regionMajor=${regionMajor}, boardId=${boardId}, postId=${postId}, commentPage=${comments.getNumber()}, commentPagingSize=${commentPagingInfo.commentPagingSize}, commentSort=${commentPagingInfo.commentSort} ) }'|">
                    <</button>
                &nbsp; &nbsp;
                <span class="pagination-info">[[${comments.getNumber()+1}]] / [[${comments.getTotalElements() == 0 ? 1 : comments.getTotalPages()}]]</span>
                &nbsp; &nbsp;
                <button class="pagination-button" th:disabled="${!comments.hasNext()}"
                        th:onclick="|location.href='@{/board/{regionMajor}/{boardId}/posts/{postId}(regionMajor=${regionMajor}, boardId=${boardId}, postId=${postId}, commentPage=${comments.getNumber()+2}, commentPagingSize=${commentPagingInfo.commentPagingSize}, commentSort=${commentPagingInfo.commentSort} ) }'|">
                    ></button>
                <button class="pagination-button" th:disabled="${!comments.hasNext()}"
                        th:onclick="|location.href='@{/board/{regionMajor}/{boardId}/posts/{postId}(regionMajor=${regionMajor}, boardId=${boardId}, postId=${postId}, commentPage=${comments.getTotalPages()}, commentPagingSize=${commentPagingInfo.commentPagingSize}, commentSort=${commentPagingInfo.commentSort} ) }'|">
                    >></button>
            </div>
        </div>

    </main>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/js/footer.js"></script>
<script src="/js/post_delete.js"></script>
<script src="/js/comment_photos.js"></script>
<script src="/js/comment_delete.js"></script>
<script src="/js/comment_sort.js"></script>
<script src="/js/comment_like.js"></script>
<script src="/js/reply.js"></script>

</body>
<script>
    function previewImage(event) {
        var reader = new FileReader();
        reader.onload = function () {
            var output = document.getElementById('imagePreview');
            var placeholder = document.getElementById('imagePlaceholder');
            output.src = reader.result;
            output.style.display = 'block';
            placeholder.style.display = 'none'; // 이미지가 업로드되면 플레이스홀더 텍스트 숨기기
        };
        reader.readAsDataURL(event.target.files[0]);
    }
</script>
</html>